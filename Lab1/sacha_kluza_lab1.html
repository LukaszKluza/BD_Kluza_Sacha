<!DOCTYPE html>
<html>
<head>
<title>sacha_kluza_lab1.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="oracle-plsql">Oracle PL/Sql</h1>
<p>widoki, funkcje, procedury, triggery
ćwiczenie</p>
<hr>
<p>Imiona i nazwiska autorów :
Kluza Łukasz
Mateusz Sacha</p>
<hr>
<style>
  {
    font-size: 16pt;
  }
</style> 
<style scoped>
 li, p {
    font-size: 14pt;
  }
</style> 
<style scoped>
 pre {
    font-size: 10pt;
  }
</style> 
<h1 id="tabele">Tabele</h1>
<p><img src="_img/ora-trip1-0.png" alt=""></p>
<ul>
<li>
<p><code>Trip</code>  - wycieczki</p>
<ul>
<li><code>trip_id</code> - identyfikator, klucz główny</li>
<li><code>trip_name</code> - nazwa wycieczki</li>
<li><code>country</code> - nazwa kraju</li>
<li><code>trip_date</code> - data</li>
<li><code>max_no_places</code> -  maksymalna liczba miejsc na wycieczkę</li>
</ul>
</li>
<li>
<p><code>Person</code> - osoby</p>
<ul>
<li><code>person_id</code> - identyfikator, klucz główny</li>
<li><code>firstname</code> - imię</li>
<li><code>lastname</code> - nazwisko</li>
</ul>
</li>
<li>
<p><code>Reservation</code>  - rezerwacje</p>
<ul>
<li><code>reservation_id</code> - identyfikator, klucz główny</li>
<li><code>trip_id</code> - identyfikator wycieczki</li>
<li><code>person_id</code> - identyfikator osoby</li>
<li><code>status</code> - status rezerwacji
<ul>
<li><code>N</code> – New - Nowa</li>
<li><code>P</code> – Confirmed and Paid – Potwierdzona  i zapłacona</li>
<li><code>C</code> – Canceled - Anulowana</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>Log</code> - dziennik zmian statusów rezerwacji</p>
<ul>
<li><code>log_id</code> - identyfikator, klucz główny</li>
<li><code>reservation_id</code> - identyfikator rezerwacji</li>
<li><code>log_date</code> - data zmiany</li>
<li><code>status</code> - status</li>
</ul>
</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_person_seq  
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>  
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> person  
(  
  person_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">constraint</span> pk_person  
         primary <span class="hljs-keyword">key</span>,
  firstname <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),  
  lastname <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>)
)  

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> person  
    <span class="hljs-keyword">modify</span> person_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_person_seq.nextval;
   
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_trip_seq  
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>  
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> trip  
(  
  trip_id <span class="hljs-built_in">int</span>  <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
     <span class="hljs-keyword">constraint</span> pk_trip  
         primary <span class="hljs-keyword">key</span>, 
  trip_name <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>),  
  country <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),  
  trip_date <span class="hljs-built_in">date</span>,  
  max_no_places <span class="hljs-built_in">int</span>
);  

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> trip 
    <span class="hljs-keyword">modify</span> trip_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_trip_seq.nextval;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_reservation_seq  
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>  
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> reservation  
(  
  reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">constraint</span> pk_reservation  
         primary <span class="hljs-keyword">key</span>, 
  trip_id <span class="hljs-built_in">int</span>,  
  person_id <span class="hljs-built_in">int</span>,  
  <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>)
);  

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation 
    <span class="hljs-keyword">modify</span> reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_reservation_seq.nextval;


<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation  
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_fk1 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>  
( person_id ) <span class="hljs-keyword">references</span> person ( person_id ); 
  
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation  
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_fk2 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>  
( trip_id ) <span class="hljs-keyword">references</span> trip ( trip_id );  
  
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation  
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_chk1 <span class="hljs-keyword">check</span>  
(<span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'N'</span>,<span class="hljs-string">'P'</span>,<span class="hljs-string">'C'</span>));

</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_log_seq  
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>  
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;


<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>  
(  
    log_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
         <span class="hljs-keyword">constraint</span> pk_log  
         primary <span class="hljs-keyword">key</span>,
    reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,  
    log_date <span class="hljs-built_in">date</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,  
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>)
);  

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span> 
    <span class="hljs-keyword">modify</span> log_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_log_seq.nextval;
  
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>  
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> log_chk1 <span class="hljs-keyword">check</span>  
(<span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'N'</span>,<span class="hljs-string">'P'</span>,<span class="hljs-string">'C'</span>)) <span class="hljs-keyword">enable</span>;
  
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>  
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> log_fk1 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>  
( reservation_id ) <span class="hljs-keyword">references</span> reservation ( reservation_id );
</div></code></pre>
<hr>
<h1 id="dane">Dane</h1>
<p>Należy wypełnić  tabele przykładowymi danymi</p>
<ul>
<li>4 wycieczki</li>
<li>10 osób</li>
<li>10  rezerwacji</li>
</ul>
<p>Dane testowe powinny być różnorodne (wycieczki w przyszłości, wycieczki w przeszłości, rezerwacje o różnym statusie itp.) tak, żeby umożliwić testowanie napisanych procedur.</p>
<p>W razie potrzeby należy zmodyfikować dane tak żeby przetestować różne przypadki.</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- trip</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date, max_no_places)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Wycieczka do Paryza'</span>, <span class="hljs-string">'Francja'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2023-09-12'</span>, <span class="hljs-string">'YYYY-MM-DD'</span>), <span class="hljs-number">3</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date,  max_no_places)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Piekny Krakow'</span>, <span class="hljs-string">'Polska'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2025-05-03'</span>,<span class="hljs-string">'YYYY-MM-DD'</span>), <span class="hljs-number">2</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date,  max_no_places)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Znow do Francji'</span>, <span class="hljs-string">'Francja'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2025-05-01'</span>,<span class="hljs-string">'YYYY-MM-DD'</span>), <span class="hljs-number">2</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date,  max_no_places)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Hel'</span>, <span class="hljs-string">'Polska'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2025-05-01'</span>,<span class="hljs-string">'YYYY-MM-DD'</span>),  <span class="hljs-number">2</span>);

<span class="hljs-comment">-- person</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Nowak'</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Kowalski'</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)  
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Nowakowski'</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)  
<span class="hljs-keyword">values</span>  (<span class="hljs-string">'Novak'</span>, <span class="hljs-string">'Nowak'</span>);

<span class="hljs-comment">-- reservation</span>
<span class="hljs-comment">-- trip1</span>
<span class="hljs-keyword">insert</span>  <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)  
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'P'</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)  
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'N'</span>);  
  
<span class="hljs-comment">-- trip 2  </span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)  
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'P'</span>);  
  
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)  
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'C'</span>);  
  
<span class="hljs-comment">-- trip 3  </span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)  
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'P'</span>);
</div></code></pre>
<p>proszę pamiętać o zatwierdzeniu transakcji</p>
<hr>
<h1 id="zadanie-0---modyfikacja-danych-transakcje">Zadanie 0 - modyfikacja danych, transakcje</h1>
<p>Należy przeprowadzić kilka eksperymentów związanych ze wstawianiem, modyfikacją i usuwaniem danych
oraz wykorzystaniem transakcji</p>
<p>Skomentuj dzialanie transakcji. Jak działa polecenie <code>commit</code>, <code>rollback</code>?.
Co się dzieje w przypadku wystąpienia błędów podczas wykonywania transakcji? Porównaj sposób programowania operacji wykorzystujących transakcje w Oracle PL/SQL ze znanym ci systemem/językiem MS Sqlserver T-SQL</p>
<p>pomocne mogą być materiały dostępne tu:
https://upel.agh.edu.pl/mod/folder/view.php?id=214774
w szczególności dokument: <code>1_modyf.pdf</code></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- person</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Ala'</span>, <span class="hljs-string">'Nowakowska'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Kowalski'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Anna'</span>, <span class="hljs-string">'Kowalczyk'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span>  (<span class="hljs-string">'Katarzyna'</span>, <span class="hljs-string">'Wojciechowska'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Andrzej '</span>, <span class="hljs-string">'Kaczmarek'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span>  (<span class="hljs-string">'Marek '</span>, <span class="hljs-string">'Kwiatkowski'</span>);

<span class="hljs-comment">-- reservation</span>
<span class="hljs-comment">-- trip 1</span>
<span class="hljs-keyword">insert</span>  <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'N'</span>);

<span class="hljs-comment">-- trip 2</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">9</span>, <span class="hljs-string">'C'</span>);

<span class="hljs-comment">-- trip 3</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-string">'N'</span>);

<span class="hljs-comment">-- trip 4</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-string">'C'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'C'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-string">'P'</span>);

</div></code></pre>
<hr>
<h1 id="zadanie-1---widoki">Zadanie 1 - widoki</h1>
<p>Tworzenie widoków. Należy przygotować kilka widoków ułatwiających dostęp do danych. Należy zwrócić uwagę na strukturę kodu (należy unikać powielania kodu)</p>
<p>Widoki:</p>
<ul>
<li><code>vw_reservation</code>
<ul>
<li>widok łączy dane z tabel: <code>trip</code>,  <code>person</code>,  <code>reservation</code></li>
<li>zwracane dane:  <code>reservation_id</code>,  <code>country</code>, <code>trip_date</code>, <code>trip_name</code>, <code>firstname</code>, <code>lastname</code>, <code>status</code>, <code>trip_id</code>, <code>person_id</code></li>
</ul>
</li>
<li><code>vw_trip</code>
<ul>
<li>widok pokazuje liczbę wolnych miejsc na każdą wycieczkę</li>
<li>zwracane dane: <code>trip_id</code>, <code>country</code>, <code>trip_date</code>, <code>trip_name</code>, <code>max_no_places</code>, <code>no_available_places</code> (liczba wolnych miejsc)</li>
</ul>
</li>
<li><code>vw_available_trip</code>
<ul>
<li>podobnie jak w poprzednim punkcie, z tym że widok pokazuje jedynie dostępne wycieczki (takie które są w przyszłości i są na nie wolne miejsca)</li>
</ul>
</li>
</ul>
<p>Proponowany zestaw widoków można rozbudować wedle uznania/potrzeb</p>
<ul>
<li>np. można dodać nowe/pomocnicze widoki</li>
<li>np. można zmienić def. widoków, dodając nowe/potrzebne pola</li>
</ul>
<h1 id="zadanie-1---rozwi%C4%85zanie">Zadanie 1  - rozwiązanie</h1>
<pre class="hljs"><code><div>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">view</span> vw_reservation <span class="hljs-keyword">as</span>
<span class="hljs-keyword">select</span> reservation_id, country, trip_date, trip_name, firstname, lastname, <span class="hljs-keyword">status</span>, r.trip_id, r.person_id  <span class="hljs-keyword">from</span> reservation r
<span class="hljs-keyword">join</span> trip t <span class="hljs-keyword">on</span> t.TRIP_ID = r.TRIP_ID
<span class="hljs-keyword">join</span> person p <span class="hljs-keyword">on</span> p.PERSON_ID = r.PERSON_ID



<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">view</span> vw_trip <span class="hljs-keyword">as</span>
<span class="hljs-keyword">with</span> reservation_counter <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> trip_id, <span class="hljs-keyword">count</span>(*) counter
                             <span class="hljs-keyword">from</span> reservation r_in
                             <span class="hljs-keyword">where</span> <span class="hljs-keyword">status</span> &lt;&gt; <span class="hljs-string">'C'</span>
                             <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> trip_id)

<span class="hljs-keyword">select</span> t.trip_id,
       country,
       trip_date,
       trip_name,
       max_no_places,
       max_no_Places-counter no_available_places
<span class="hljs-keyword">from</span> trip t
        <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> reservation_counter rc <span class="hljs-keyword">on</span> rc.trip_id = t.trip_id



<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">view</span> vw_available_trip <span class="hljs-keyword">as</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> vw_trip
<span class="hljs-keyword">where</span> no_available_places &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> trip_date &gt; <span class="hljs-keyword">sysdate</span>
</div></code></pre>
<hr>
<h1 id="zadanie-2---funkcje">Zadanie 2  - funkcje</h1>
<p>Tworzenie funkcji pobierających dane/tabele. Podobnie jak w poprzednim przykładzie należy przygotować kilka funkcji ułatwiających dostęp do danych</p>
<p>Procedury:</p>
<ul>
<li><code>f_trip_participants</code>
<ul>
<li>zadaniem funkcji jest zwrócenie listy uczestników wskazanej wycieczki</li>
<li>parametry funkcji: <code>trip_id</code></li>
<li>funkcja zwraca podobny zestaw danych jak widok  <code>vw_eservation</code></li>
</ul>
</li>
<li><code>f_person_reservations</code>
<ul>
<li>zadaniem funkcji jest zwrócenie listy rezerwacji danej osoby</li>
<li>parametry funkcji: <code>person_id</code></li>
<li>funkcja zwraca podobny zestaw danych jak widok <code>vw_reservation</code></li>
</ul>
</li>
<li><code>f_available_trips_to</code>
<ul>
<li>zadaniem funkcji jest zwrócenie listy wycieczek do wskazanego kraju, dostępnych w zadanym okresie czasu (od <code>date_from</code> do <code>date_to</code>)</li>
<li>parametry funkcji: <code>country</code>, <code>date_from</code>, <code>date_to</code></li>
</ul>
</li>
</ul>
<p>Funkcje powinny zwracać tabelę/zbiór wynikowy. Należy rozważyć dodanie kontroli parametrów, (np. jeśli parametrem jest <code>trip_id</code> to można sprawdzić czy taka wycieczka istnieje). Podobnie jak w przypadku widoków należy zwrócić uwagę na strukturę kodu</p>
<p>Czy kontrola parametrów w przypadku funkcji ma sens?</p>
<ul>
<li>jakie są zalety/wady takiego rozwiązania?</li>
</ul>
<p>Proponowany zestaw funkcji można rozbudować wedle uznania/potrzeb</p>
<ul>
<li>np. można dodać nowe/pomocnicze funkcje/procedury</li>
</ul>
<h1 id="zadanie-2---rozwi%C4%85zanie">Zadanie 2  - rozwiązanie</h1>
<ul>
<li>2.1 <em>f_trip_participants</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> trip_participants <span class="hljs-keyword">as</span> <span class="hljs-keyword">OBJECT</span>
(
    trip_id        <span class="hljs-built_in">int</span>,
    reservation_id <span class="hljs-built_in">int</span>,
    country        <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    trip_date      <span class="hljs-built_in">date</span>,
    trip_name      <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>),
    firstname      <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    lastname       <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    <span class="hljs-keyword">status</span>         <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>),
    person_id      <span class="hljs-built_in">int</span>
);

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> trip_participants_table <span class="hljs-keyword">is</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">of</span> trip_participants;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> f_trip_participants(trip_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> trip_participants_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> trip_participants_table;
    counter int;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*)
    <span class="hljs-keyword">into</span> counter
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">where</span> t.trip_id = f_trip_participants.trip_id;

    if counter = 0 then
        raise_application_error(-20001, 'Trip ' || f_trip_participants.trip_id
        || ' does not exist');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> trip_participants(vwr.trip_id, vwr.reservation_id, vwr.country,
    vwr.trip_date, vwr.trip_name, vwr.firstname, vwr.lastname, vwr.status, vwr.person_id) 
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> vw_reservation vwr
    <span class="hljs-keyword">where</span> vwr.trip_id = f_trip_participants.trip_id
      <span class="hljs-keyword">and</span> vwr.status = <span class="hljs-string">'P'</span>;

    return result;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<ul>
<li>2.2 <em>f_person_reservations</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> person_reservation <span class="hljs-keyword">as</span> <span class="hljs-keyword">OBJECT</span>
(
    trip_id        <span class="hljs-built_in">int</span>,
    reservation_id <span class="hljs-built_in">int</span>,
    country        <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    trip_date      <span class="hljs-built_in">date</span>,
    trip_name      <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>),
    firstname      <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    lastname       <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    <span class="hljs-keyword">status</span>         <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>),
    person_id      <span class="hljs-built_in">int</span>
);

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> person_reservations_table <span class="hljs-keyword">is</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">of</span> person_reservation;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> f_person_reservations(person_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> person_reservations_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> person_reservations_table;
    counter int;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*)
    <span class="hljs-keyword">into</span> counter
    <span class="hljs-keyword">from</span> person p
    <span class="hljs-keyword">where</span> p.person_id = f_person_reservations.person_id;

    if counter = 0 then
        raise_application_error(-20001, 'Person ' || f_person_reservations.person_id || ' does not exist');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> person_reservation(vwr.trip_id, vwr.reservation_id, vwr.country,
    vwr.trip_date, vwr.trip_name, vwr.firstname, vwr.lastname, vwr.status, vwr.person_id) 
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> vw_reservation vwr
    <span class="hljs-keyword">where</span> vwr.person_id = f_person_reservations.person_id;
    return result;
<span class="hljs-keyword">end</span>;

</div></code></pre>
<p>2.3 f_available_trips_to</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> country_trip <span class="hljs-keyword">as</span> <span class="hljs-keyword">OBJECT</span>
(
    trip_id        <span class="hljs-built_in">int</span>,
    country        <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    trip_date      <span class="hljs-built_in">date</span>,
    trip_name      <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> f_available_trips_to(
    country_name <span class="hljs-built_in">VARCHAR2</span>,
    date_from <span class="hljs-built_in">DATE</span>,
    date_to <span class="hljs-built_in">DATE</span>
)
<span class="hljs-keyword">RETURN</span> country_trip_table
<span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">result</span> country_trip_table := country_trip_table();
    counter INT := 0;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
    <span class="hljs-keyword">INTO</span> counter
    <span class="hljs-keyword">FROM</span> trip t
    <span class="hljs-keyword">WHERE</span> t.country = country_name
        <span class="hljs-keyword">AND</span> t.trip_date &gt;= date_from <span class="hljs-keyword">AND</span> t.trip_date &lt;= date_to;

    IF counter = 0 THEN
        raise_application_error(-20001, 'Trip to ' || country_name 
        || ' does not exist between: ' || date_from ||' and ' || date_to);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> country_trip(t.trip_id, t.country, t.trip_date, t.trip_name)
    <span class="hljs-keyword">BULK</span> <span class="hljs-keyword">COLLECT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">FROM</span> trip t
    <span class="hljs-keyword">WHERE</span> t.country = country_name
        <span class="hljs-keyword">AND</span> t.trip_date &gt;= date_from <span class="hljs-keyword">AND</span> t.trip_date &lt;= date_to;

    RETURN result;
<span class="hljs-keyword">END</span>;
</div></code></pre>
<h1 id="zadanie-3---procedury">Zadanie 3  - procedury</h1>
<p>Tworzenie procedur modyfikujących dane. Należy przygotować zestaw procedur pozwalających na modyfikację danych oraz kontrolę poprawności ich wprowadzania</p>
<p>Procedury</p>
<ul>
<li><code>p_add_reservation</code>
<ul>
<li>zadaniem procedury jest dopisanie nowej rezerwacji</li>
<li>parametry: <code>trip_id</code>, <code>person_id</code>,</li>
<li>procedura powinna kontrolować czy wycieczka jeszcze się nie odbyła, i czy sa wolne miejsca</li>
<li>procedura powinna również dopisywać inf. do tabeli <code>log</code></li>
</ul>
</li>
<li><code>p_modify_reservation_tatus</code>
<ul>
<li>zadaniem procedury jest zmiana statusu rezerwacji</li>
<li>parametry: <code>reservation_id</code>, <code>status</code></li>
<li>procedura powinna kontrolować czy możliwa jest zmiana statusu, np. zmiana statusu już anulowanej wycieczki (przywrócenie do stanu aktywnego nie zawsze jest możliwa – może już nie być miejsc)</li>
<li>procedura powinna również dopisywać inf. do tabeli <code>log</code></li>
</ul>
</li>
</ul>
<p>Procedury:</p>
<ul>
<li><code>p_modify_max_no_places</code>
<ul>
<li>zadaniem procedury jest zmiana maksymalnej liczby miejsc na daną wycieczkę</li>
<li>parametry: <code>trip_id</code>, <code>max_no_places</code></li>
<li>nie wszystkie zmiany liczby miejsc są dozwolone, nie można zmniejszyć liczby miejsc na wartość poniżej liczby zarezerwowanych miejsc</li>
</ul>
</li>
</ul>
<p>Należy rozważyć użycie transakcji</p>
<p>Należy zwrócić uwagę na kontrolę parametrów (np. jeśli parametrem jest trip_id to należy sprawdzić czy taka wycieczka istnieje, jeśli robimy rezerwację to należy sprawdzać czy są wolne miejsca itp..)</p>
<p>Proponowany zestaw procedur można rozbudować wedle uznania/potrzeb</p>
<ul>
<li>np. można dodać nowe/pomocnicze funkcje/procedury</li>
</ul>
<h1 id="zadanie-3---rozwi%C4%85zanie">Zadanie 3  - rozwiązanie</h1>
<ul>
<li>3.1 <em>p_add_reservation</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_person_id <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_no_places INT;
    v_reservation_id INT;
    v_trip_exists INT;
    v_person_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_trip_exists
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Trip does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_person_exists
    <span class="hljs-keyword">FROM</span> person
    <span class="hljs-keyword">WHERE</span> person_id = p_person_id;

    IF v_person_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Person does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> trip_date <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_date &lt; SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20001, 'This trip has already taken place.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> max_no_places - NVL((<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> reservation <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id), <span class="hljs-number">0</span>)
    <span class="hljs-keyword">INTO</span> v_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_no_places &lt;= 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'There are no available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (p_trip_id, p_person_id, <span class="hljs-string">'N'</span>)
    <span class="hljs-keyword">RETURNING</span> reservation_id <span class="hljs-keyword">INTO</span> v_reservation_id;
    
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">log</span>(reservation_id,log_date,<span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (v_reservation_id, <span class="hljs-keyword">SYSDATE</span>, <span class="hljs-string">'N'</span>);
</div></code></pre>
<ul>
<li>3.2 <em>p_modify_reservation_status</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status(
    p_reservation_id <span class="hljs-built_in">INT</span>,
    p_status <span class="hljs-built_in">CHAR</span>
)
<span class="hljs-keyword">AS</span>
    v_status <span class="hljs-built_in">CHAR</span>;
    v_no_places INT;
    v_trip_id INT;
    v_reservation_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reservation_exists
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_reservation_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Reservation does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>,trip_id <span class="hljs-keyword">INTO</span> v_status,v_trip_id
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    <span class="hljs-keyword">SELECT</span> max_no_places - NVL((<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> reservation <span class="hljs-keyword">WHERE</span> trip_id = v_trip_id), <span class="hljs-number">0</span>)
    <span class="hljs-keyword">INTO</span> v_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = v_trip_id;

    IF v_status = 'C' or (p_status = 'N' and v_status = 'P') THEN
        RAISE_APPLICATION_ERROR(-20001, 'It is no possible 
        to <span class="hljs-keyword">change</span> the <span class="hljs-keyword">status</span> reservation<span class="hljs-string">');
    END IF;

    UPDATE reservation
    SET status = p_status
    WHERE reservation_id = p_reservation_id;

    INSERT INTO log(reservation_id,log_date,status)
    VALUES (p_reservation_id, SYSDATE, p_status);
END;
</span></div></code></pre>
<ul>
<li>3.3 <em>p_modify_max_no_places</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_max_no_places(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_max_no_places <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_current_reservations <span class="hljs-built_in">INT</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
    <span class="hljs-keyword">INTO</span> v_current_reservations
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_current_reservations = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Trip <span class="hljs-keyword">with</span> specified trip_id does <span class="hljs-keyword">not</span> exist.<span class="hljs-string">');
    END IF;

    SELECT COUNT(*)
    INTO v_current_reservations
    FROM reservation
    WHERE trip_id = p_trip_id;

    IF p_max_no_places &lt; v_current_reservations THEN
        RAISE_APPLICATION_ERROR(-20001, '</span><span class="hljs-keyword">New</span> maximum <span class="hljs-built_in">number</span>
        <span class="hljs-keyword">of</span> places cannot be <span class="hljs-keyword">less</span> <span class="hljs-keyword">than</span> <span class="hljs-keyword">current</span> reservations.<span class="hljs-string">');
    END IF;

    UPDATE trip
    SET max_no_places = p_max_no_places
    WHERE trip_id = p_trip_id;

END;
</span></div></code></pre>
<hr>
<h1 id="zadanie-4---triggery">Zadanie 4  - triggery</h1>
<p>Zmiana strategii zapisywania do dziennika rezerwacji. Realizacja przy pomocy triggerów</p>
<p>Należy wprowadzić zmianę, która spowoduje, że zapis do dziennika rezerwacji będzie realizowany przy pomocy trierów</p>
<p>Triggery:</p>
<ul>
<li>trigger/triggery obsługujące
<ul>
<li>dodanie rezerwacji</li>
<li>zmianę statusu</li>
</ul>
</li>
<li>trigger zabraniający usunięcia rezerwacji</li>
</ul>
<p>Oczywiście po wprowadzeniu tej zmiany należy &quot;uaktualnić&quot; procedury modyfikujące dane.</p>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych procedur (dodając do nazwy dopisek 4 - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu  umożliwienia weryfikacji ich poprawności</p>
</blockquote>
<p>Należy przygotować procedury: <code>p_add_reservation_4</code>, <code>p_modify_reservation_status_4</code></p>
<h1 id="zadanie-4---rozwi%C4%85zanie">Zadanie 4  - rozwiązanie</h1>
<ul>
<li>4.1 <em>trg_reservation_insert</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_reservation_insert
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> reservation
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">log</span>(reservation_id, log_date, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (:NEW.reservation_id, <span class="hljs-keyword">SYSDATE</span>, :NEW.status);
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>4.2 <em>trg_reservation_status_update</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_reservation_status_update
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OF</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">ON</span> reservation
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">log</span>(reservation_id, log_date, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (:OLD.reservation_id, <span class="hljs-keyword">SYSDATE</span>, :NEW.status);
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>4.3 <em>trg_reservation_delete</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_reservation_delete
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> reservation
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    RAISE_APPLICATION_ERROR(<span class="hljs-number">-20001</span>, <span class="hljs-string">'Deleting reservations is not allowed.'</span>);
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>4.4 <em>p_add_reservation_4</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation_4(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_person_id <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_no_places INT;
    v_reservation_id INT;
    v_trip_exists INT;
    v_person_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_trip_exists
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Trip does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_person_exists
    <span class="hljs-keyword">FROM</span> person
    <span class="hljs-keyword">WHERE</span> person_id = p_person_id;

    IF v_person_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Person does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> trip_date <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_date &lt; SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20001, 'This trip has already taken place.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> max_no_places - NVL((<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> reservation <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id), <span class="hljs-number">0</span>)
    <span class="hljs-keyword">INTO</span> v_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_no_places &lt;= 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'There are no available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (p_trip_id, p_person_id, <span class="hljs-string">'N'</span>)
    <span class="hljs-keyword">RETURNING</span> reservation_id <span class="hljs-keyword">INTO</span> v_reservation_id;

<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>4.5 <em>p_modify_reservation_status_4</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status_4(
    p_reservation_id <span class="hljs-built_in">INT</span>,
    p_status <span class="hljs-built_in">CHAR</span>
)
<span class="hljs-keyword">AS</span>
    v_status <span class="hljs-built_in">CHAR</span>;
    v_no_places INT;
    v_trip_id INT;
    v_reservation_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reservation_exists
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_reservation_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Reservation does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>,trip_id <span class="hljs-keyword">INTO</span> v_status,v_trip_id
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    <span class="hljs-keyword">SELECT</span> max_no_places - NVL((<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> reservation <span class="hljs-keyword">WHERE</span> trip_id = v_trip_id), <span class="hljs-number">0</span>)
    <span class="hljs-keyword">INTO</span> v_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = v_trip_id;

    IF v_status = 'C' or (p_status = 'N' and v_status = 'P') THEN
        RAISE_APPLICATION_ERROR(-20001, 'It is no possible to <span class="hljs-keyword">change</span> the <span class="hljs-keyword">status</span> reservation<span class="hljs-string">');
    END IF;

    UPDATE reservation
    SET status = p_status
    WHERE reservation_id = p_reservation_id;

END;
</span></div></code></pre>
<hr>
<h1 id="zadanie-5---triggery">Zadanie 5  - triggery</h1>
<p>Zmiana strategii kontroli dostępności miejsc. Realizacja przy pomocy triggerów</p>
<p>Należy wprowadzić zmianę, która spowoduje, że kontrola dostępności miejsc na wycieczki (przy dodawaniu nowej rezerwacji, zmianie statusu) będzie realizowana przy pomocy trierów</p>
<p>Triggery:</p>
<ul>
<li>Trigger/triggery obsługujące:
<ul>
<li>dodanie rezerwacji</li>
<li>zmianę statusu</li>
</ul>
</li>
</ul>
<p>Oczywiście po wprowadzeniu tej zmiany należy &quot;uaktualnić&quot; procedury modyfikujące dane.</p>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych procedur (np. dodając do nazwy dopisek 5 - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu  umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<p>Należy przygotować procedury: <code>p_add_reservation_5</code>, <code>p_modify_reservation_status_5</code></p>
<h1 id="zadanie-5---rozwi%C4%85zanie">Zadanie 5  - rozwiązanie</h1>
<ul>
<li>5.1 <em>trg_add_reservation</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_add_reservation
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> reservation
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_max_no_places <span class="hljs-built_in">INT</span>;
    v_reserved_places INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> max_no_places <span class="hljs-keyword">INTO</span> v_max_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = :NEW.trip_id;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reserved_places
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> trip_id = :NEW.trip_id;

    IF v_reserved_places &gt;= v_max_no_places THEN
        RAISE_APPLICATION_ERROR(-20001, 'There are no available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>5.2 <em>trg_modify_reservation_status</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_modify_reservation_status
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OF</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">ON</span> reservation
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_max_no_places <span class="hljs-built_in">INT</span>;
    v_reserved_places INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> max_no_places <span class="hljs-keyword">INTO</span> v_max_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = :NEW.trip_id;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reserved_places
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> trip_id = :NEW.trip_id;

    IF v_reserved_places &gt;= v_max_no_places and :OLD.status = 'C' and :NEW.status = 'P' THEN
        RAISE_APPLICATION_ERROR(-20001, 'There are no available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>5.3 <em>p_add_reservation_5</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation_5(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_person_id <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_no_places INT;
    v_reservation_id INT;
    v_trip_exists INT;
    v_person_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_trip_exists
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Trip does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_person_exists
    <span class="hljs-keyword">FROM</span> person
    <span class="hljs-keyword">WHERE</span> person_id = p_person_id;

    IF v_person_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Person does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> trip_date <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_date &lt; SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20001, 'This trip has already taken place.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (p_trip_id, p_person_id, <span class="hljs-string">'N'</span>)
    <span class="hljs-keyword">RETURNING</span> reservation_id <span class="hljs-keyword">INTO</span> v_reservation_id;

<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>5.4 <em>p_modify_reservation_status_5</em></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status_5(
    p_reservation_id <span class="hljs-built_in">INT</span>,
    p_status <span class="hljs-built_in">CHAR</span>
)
<span class="hljs-keyword">AS</span>
    v_status <span class="hljs-built_in">CHAR</span>;
    v_no_places INT;
    v_trip_id INT;
    v_reservation_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reservation_exists
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_reservation_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Reservation does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>,trip_id <span class="hljs-keyword">INTO</span> v_status,v_trip_id
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    <span class="hljs-keyword">UPDATE</span> reservation
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = p_status
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

<span class="hljs-keyword">END</span>;
</div></code></pre>
<hr>
<h1 id="zadanie-6">Zadanie 6</h1>
<p>Zmiana struktury bazy danych. W tabeli <code>trip</code>  należy dodać  redundantne pole <code>no_available_places</code>.  Dodanie redundantnego pola uprości kontrolę dostępnych miejsc, ale nieco skomplikuje procedury dodawania rezerwacji, zmiany statusu czy też zmiany maksymalnej liczby miejsc na wycieczki.</p>
<p>Należy przygotować polecenie/procedurę przeliczającą wartość pola <code>no_available_places</code> dla wszystkich wycieczek (do jednorazowego wykonania)</p>
<p>Obsługę pola <code>no_available_places</code> można zrealizować przy pomocy procedur lub triggerów</p>
<p>Należy zwrócić uwagę na spójność rozwiązania.</p>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych widoków/procedur/triggerów (np. dodając do nazwy dopisek 6 - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu  umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<ul>
<li>zmiana struktury tabeli</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> trip <span class="hljs-keyword">add</span>  
    no_available_places <span class="hljs-built_in">int</span> <span class="hljs-literal">null</span>
</div></code></pre>
<ul>
<li>polecenie przeliczające wartość <code>no_available_places</code>
<ul>
<li>należy wykonać operację &quot;przeliczenia&quot;  liczby wolnych miejsc i aktualizacji pola  <code>no_available_places</code></li>
</ul>
</li>
</ul>
<h1 id="zadanie-6---rozwi%C4%85zanie">Zadanie 6  - rozwiązanie</h1>
<hr>
<h1 id="zadanie-6a---procedury">Zadanie 6a  - procedury</h1>
<p>Obsługę pola <code>no_available_places</code> należy zrealizować przy pomocy procedur</p>
<ul>
<li>procedura dodająca rezerwację powinna aktualizować pole <code>no_available_places</code> w tabeli trip</li>
<li>podobnie procedury odpowiedzialne za zmianę statusu oraz zmianę maksymalnej liczby miejsc na wycieczkę</li>
<li>należy przygotować procedury oraz jeśli jest to potrzebne, zaktualizować triggery oraz widoki</li>
</ul>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych widoków/procedur/triggerów (np. dodając do nazwy dopisek 6a - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu  umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<ul>
<li>może  być potrzebne wyłączenie 'poprzednich wersji' triggerów</li>
</ul>
<h1 id="zadanie-6a---rozwi%C4%85zanie">Zadanie 6a  - rozwiązanie</h1>
<ul>
<li>6a 1.no_available_places</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> no_available_places <span class="hljs-keyword">is</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">UPDATE</span> trip t1
<span class="hljs-keyword">SET</span> no_available_places = (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(person_id)
                           <span class="hljs-keyword">from</span> vw_reservation vwr
                           <span class="hljs-keyword">where</span> vwr.status &lt;&gt; <span class="hljs-string">'C'</span> <span class="hljs-keyword">and</span> t1.trip_id = vwr.trip_id);
<span class="hljs-keyword">end</span>;
</div></code></pre>
<ul>
<li>6a 2.p_add_reservation_6</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation_6a(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_person_id <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_no_places INT;
    v_reservation_id INT;
    v_trip_exists INT;
    v_person_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_trip_exists
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Trip does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_person_exists
    <span class="hljs-keyword">FROM</span> person
    <span class="hljs-keyword">WHERE</span> person_id = p_person_id;

    IF v_person_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Person does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> trip_date <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_date &lt; SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20001, 'This trip has already taken place.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> MAX_NO_PLACES - NO_AVAILABLE_PLACES
    <span class="hljs-keyword">INTO</span> v_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_no_places &lt;= 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'There are no available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (p_trip_id, p_person_id, <span class="hljs-string">'N'</span>)
    <span class="hljs-keyword">RETURNING</span> reservation_id <span class="hljs-keyword">INTO</span> v_reservation_id;

    no_available_places();
    DBMS_OUTPUT.PUT_LINE('Reservation added successfully.');
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>6a 3.p_modify_max_no_places_6a</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_max_no_places_6a(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_max_no_places <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_current_reservations <span class="hljs-built_in">INT</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
    <span class="hljs-keyword">INTO</span> v_current_reservations
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_current_reservations = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Trip <span class="hljs-keyword">with</span> specified trip_id does <span class="hljs-keyword">not</span> exist.<span class="hljs-string">');
    END IF;

    SELECT t.no_available_places
    INTO v_current_reservations
    FROM trip t
    WHERE trip_id = p_trip_id;

    IF p_max_no_places &lt; v_current_reservations THEN
        RAISE_APPLICATION_ERROR(-20001, '</span><span class="hljs-keyword">New</span> maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> places cannot be <span class="hljs-keyword">less</span> <span class="hljs-keyword">than</span> <span class="hljs-keyword">current</span> reservations.<span class="hljs-string">');
    END IF;

    UPDATE trip
    SET max_no_places = p_max_no_places
    WHERE trip_id = p_trip_id;

    DBMS_OUTPUT.PUT_LINE('</span>Maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> places <span class="hljs-keyword">updated</span> successfully.<span class="hljs-string">');
    NO_AVAILABLE_PLACES();
END;
</span></div></code></pre>
<ul>
<li>6a 4.p_modify_reservation_status_6a</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status_6a(
    p_reservation_id <span class="hljs-built_in">INT</span>,
    p_status <span class="hljs-built_in">CHAR</span>
)
<span class="hljs-keyword">AS</span>
    v_status <span class="hljs-built_in">CHAR</span>;
    v_trip_id INT;
    v_reservation_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reservation_exists
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_reservation_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Reservation does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>,trip_id <span class="hljs-keyword">INTO</span> v_status,v_trip_id
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_status = 'C' or (p_status = 'N' and v_status = 'P') THEN
        RAISE_APPLICATION_ERROR(-20001, 'It is no possible to <span class="hljs-keyword">change</span> the <span class="hljs-keyword">status</span> reservation<span class="hljs-string">');
    END IF;

    UPDATE reservation
    SET status = p_status
    WHERE reservation_id = p_reservation_id;
    NO_AVAILABLE_PLACES();
    DBMS_OUTPUT.PUT_LINE('</span>Reservation <span class="hljs-keyword">status</span> <span class="hljs-keyword">updated</span> successfully.<span class="hljs-string">');
END;
</span></div></code></pre>
<hr>
<h1 id="zadanie-6b---triggery">Zadanie 6b -  triggery</h1>
<p>Obsługę pola <code>no_available_places</code> należy zrealizować przy pomocy triggerów</p>
<ul>
<li>podczas dodawania rezerwacji trigger powinien aktualizować pole <code>no_available_places</code> w tabeli trip</li>
<li>podobnie, podczas zmiany statusu rezerwacji</li>
<li>należy przygotować trigger/triggery oraz jeśli jest to potrzebne, zaktualizować procedury modyfikujące dane oraz widoki</li>
</ul>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych widoków/procedur/triggerów (np. dodając do nazwy dopisek 6b - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu  umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<ul>
<li>może  być potrzebne wyłączenie 'poprzednich wersji' triggerów</li>
</ul>
<h1 id="zadanie-6b---rozwi%C4%85zanie">Zadanie 6b  - rozwiązanie</h1>
<ul>
<li>6b 1. trg_reservation_insert_6B</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> TRG_RESERVATION_INSERT_6B
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">log</span>(reservation_id, log_date, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (:NEW.reservation_id, <span class="hljs-keyword">SYSDATE</span>, :NEW.status);
    NO_AVAILABLE_PLACES();
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>6b 2. trg_reservation_status_update_6B</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> TRG_RESERVATION_STATUS_UPDATE_6B
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">STATUS</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">log</span>(reservation_id, log_date, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (:OLD.reservation_id, <span class="hljs-keyword">SYSDATE</span>, :NEW.status);
    NO_AVAILABLE_PLACES();
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>6b 3. p_add_reservation_6b</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation_6b(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_person_id <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_no_places INT;
    v_reservation_id INT;
    v_trip_exists INT;
    v_person_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_trip_exists
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Trip does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_person_exists
    <span class="hljs-keyword">FROM</span> person
    <span class="hljs-keyword">WHERE</span> person_id = p_person_id;

    IF v_person_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Person does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> trip_date <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_trip_date &lt; SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20001, 'This trip has already taken place.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> MAX_NO_PLACES - NO_AVAILABLE_PLACES
    <span class="hljs-keyword">INTO</span> v_no_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_no_places &lt;= 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'There are no available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (p_trip_id, p_person_id, <span class="hljs-string">'N'</span>)
    <span class="hljs-keyword">RETURNING</span> reservation_id <span class="hljs-keyword">INTO</span> v_reservation_id;

    DBMS_OUTPUT.PUT_LINE('Reservation added successfully.');
<span class="hljs-keyword">END</span>;
</div></code></pre>
<ul>
<li>6b 4. p_modify_max_no_places_6b</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_max_no_places_6b(
    p_trip_id <span class="hljs-built_in">INT</span>,
    p_max_no_places <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">AS</span>
    v_current_reservations <span class="hljs-built_in">INT</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
    <span class="hljs-keyword">INTO</span> v_current_reservations
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    IF v_current_reservations = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Trip <span class="hljs-keyword">with</span> specified trip_id does <span class="hljs-keyword">not</span> exist.<span class="hljs-string">');
    END IF;

    SELECT t.no_available_places
    INTO v_current_reservations
    FROM trip t
    WHERE trip_id = p_trip_id;

    IF p_max_no_places &lt; v_current_reservations THEN
        RAISE_APPLICATION_ERROR(-20001, '</span><span class="hljs-keyword">New</span> maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> places cannot be <span class="hljs-keyword">less</span> <span class="hljs-keyword">than</span> <span class="hljs-keyword">current</span> reservations.<span class="hljs-string">');
    END IF;

    UPDATE trip
    SET max_no_places = p_max_no_places
    WHERE trip_id = p_trip_id;

    DBMS_OUTPUT.PUT_LINE('</span>Maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> places <span class="hljs-keyword">updated</span> successfully.<span class="hljs-string">');
END;
</span></div></code></pre>
<ul>
<li>6b 4. p_modify_reservation_status_6b</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status_6b(
    p_reservation_id <span class="hljs-built_in">INT</span>,
    p_status <span class="hljs-built_in">CHAR</span>
)
<span class="hljs-keyword">AS</span>
    v_status <span class="hljs-built_in">CHAR</span>;
    v_trip_id INT;
    v_reservation_exists INT;
<span class="hljs-keyword">BEGIN</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> v_reservation_exists
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_reservation_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Reservation does not exist.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>,trip_id <span class="hljs-keyword">INTO</span> v_status,v_trip_id
    <span class="hljs-keyword">FROM</span> reservation
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF v_status = 'C' or (p_status = 'N' and v_status = 'P') THEN
        RAISE_APPLICATION_ERROR(-20001, 'It is no possible to <span class="hljs-keyword">change</span> the <span class="hljs-keyword">status</span> reservation<span class="hljs-string">');
    END IF;

    UPDATE reservation
    SET status = p_status
    WHERE reservation_id = p_reservation_id;
    DBMS_OUTPUT.PUT_LINE('</span>Reservation <span class="hljs-keyword">status</span> <span class="hljs-keyword">updated</span> successfully.<span class="hljs-string">');
END;
</span></div></code></pre>
<h1 id="zadanie-7---podsumowanie">Zadanie 7 - podsumowanie</h1>
<p>Porównaj sposób programowania w systemie Oracle PL/SQL ze znanym ci systemem/językiem MS Sqlserver T-SQL</p>
<pre class="hljs"><code><div>
Programowanie w Oracle PL/SQL i Microsoft SQL Server T-SQL różni się głównie składnią i funkcjonalnościami:

1. PL/SQL: Opiera się na języku programowania proceduralnego, z blokami kodu BEGIN...END.
T-SQL: Ma bardziej zwięzłą składnię, zbliżoną do standardowego języka zapytań SQL.

2. PL/SQL: Deklaracje zmiennych na początku bloku, różnorodne typy danych.
T-SQL: Mniejszy wybór typów danych, proste deklaracje zmiennych.

3. PL/SQL: Rozbudowany mechanizm obsługi wyjątków.
T-SQL: Obsługuje wyjątki za pomocą instrukcji TRY...CATCH.

4. PL/SQL: Obsługuje transakcje za pomocą COMMIT i ROLLBACK.
T-SQL: Również wspiera transakcje, ale z inną składnią.

5. PL/SQL: Posiada funkcje do manipulacji danymi daty i czasu, takie jak SYSDATE, TO_DATE.
T-SQL: Również oferuje funkcje do pracy z danymi daty i czasu, jednak o innych nazwach 
takie jak GETDATE(), CONVERT.

6. PL/SQL: Przy tworzeniu procedur, konieczne jest zdefiniowanie obiektów 
typu tabela przed ich użyciem w procedurze.
T-SQL: Nie ma potrzeby definiowania obiektów typu tabela przed użyciem ich w procedurze.

</div></code></pre>

</body>
</html>
